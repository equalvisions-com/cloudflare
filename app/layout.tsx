import type { Metadata, Viewport } from "next";
import { ThemeProvider } from "next-themes";
import "./globals.css";
import { ConvexAuthNextjsServerProvider, convexAuthNextjsToken } from "@convex-dev/auth/nextjs/server";
import ConvexClientProvider from "@/components/ConvexClientProvider";
import { UserMenuServer, getUserProfile } from "@/components/user-menu/UserMenuServer";
import { MobileDock } from "@/components/ui/mobile-dock";
import { SidebarProvider } from "@/components/ui/sidebar-context";
import { Inter, JetBrains_Mono } from "next/font/google";
import { Suspense } from "react";
import { ErrorBoundary } from "../components/ErrorBoundary";
import dynamic from "next/dynamic";
import { ScrollResetter } from "@/components/ui/scroll-resetter";

// Dynamically import audio components with ssr disabled
const AudioProvider = dynamic(
  () => import("@/components/audio-player/AudioContext").then(mod => mod.AudioProvider),
  { ssr: false }
);

const PersistentPlayer = dynamic(
  () => import("@/components/audio-player/PersistentPlayer").then(mod => mod.PersistentPlayer),
  { ssr: false }
);

// Define viewport export for Next.js App Router
export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
  viewportFit: "cover"
};

const inter = Inter({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const jetbrainsMono = JetBrains_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Convex + Next.js + Convex Auth",
  description: "Generated by npm create convex",
  icons: {
    icon: "/convex.svg",
  },
};

// Separate component for user data with Suspense
const UserData = ({ children }: { children: React.ReactNode }) => {
  return (
    <ErrorBoundary fallback={<div className="min-h-screen flex items-center justify-center">
      <p>Could not load user data. Please try refreshing the page.</p>
    </div>}>
      <Suspense fallback={<div className="min-h-screen"></div>}>
        <UserDataLoader>
          {children}
        </UserDataLoader>
      </Suspense>
    </ErrorBoundary>
  );
};

// Async component that loads user data
async function UserDataLoader({ children }: { children: React.ReactNode }) {
  // Add a timeout to prevent infinite loading during cold starts
  const profilePromise = Promise.race([
    getUserProfile(),
    new Promise<any>((resolve) => setTimeout(() => {
      // Return default values if profile loading times out
      resolve({
        displayName: "Guest", 
        username: "Guest", 
        isAuthenticated: false, 
        isBoarded: false, 
        profileImage: undefined, 
        userId: null, 
        pendingFriendRequestCount: 0
      });
    }, 5000)) // 5 second timeout
  ]);
  
  const { displayName, username, isAuthenticated, isBoarded, profileImage, userId, pendingFriendRequestCount } = await profilePromise;
  
  // If we have user data from Convex, we can trust the isBoarded value
  // This is the single source of truth
  
  return (
    <SidebarProvider 
      isAuthenticated={isAuthenticated} 
      username={username}
      displayName={displayName}
      isBoarded={isBoarded}
      profileImage={profileImage}
      userId={userId}
      pendingFriendRequestCount={pendingFriendRequestCount}
    >
      {children}
    </SidebarProvider>
  );
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <ConvexAuthNextjsServerProvider>
      {/* `suppressHydrationWarning` only affects the html tag,
      // and is needed by `ThemeProvider` which sets the theme
      // class attribute on it */}
      <html lang="en" suppressHydrationWarning>
        <head>
        </head>
        <body
          className={`${inter.variable} ${jetbrainsMono.variable} antialiased no-overscroll min-h-screen flex flex-col`}
        >
          <ConvexClientProvider>
            <ThemeProvider attribute="class" enableSystem={true} disableTransitionOnChange={true}>
              <AudioProvider>
                <UserData>
                  <ScrollResetter>
                    <div className="">
                      <div className="hidden">
                        <Suspense fallback={null}>
                          <UserMenuServer />
                        </Suspense>
                      </div>
                      {children}
                    </div>
                    <PersistentPlayer />
                    <MobileDock />
                  </ScrollResetter>
                </UserData>
              </AudioProvider>
            </ThemeProvider>
          </ConvexClientProvider>
        </body>
      </html>
    </ConvexAuthNextjsServerProvider>
  );
}
